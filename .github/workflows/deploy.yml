name: Trigger Remote Git Pull on All Servers

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  notify-servers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Hawks Nest Server (North Carolina)
        env:
          SERVER_HOST: ${{ secrets.HAWKSNEST_HOST }}
          SERVER_USER: ${{ secrets.HAWKSNEST_USER }}
          SERVER_PATH: ${{ secrets.HAWKSNEST_PATH }}
          SSH_KEY: ${{ secrets.HAWKSNEST_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > deploy_key
          chmod 600 deploy_key
          ssh -i deploy_key -o StrictHostKeyChecking=no \
            ${SERVER_USER}@${SERVER_HOST} \
            "cd ${SERVER_PATH} && git pull origin main && composer install --no-dev --optimize-autoloader"
          rm -f deploy_key
      
      - name: Trigger Location 2
        env:
          SERVER_HOST: ${{ secrets.LOCATION2_HOST }}
          SERVER_USER: ${{ secrets.LOCATION2_USER }}
          SERVER_PATH: ${{ secrets.LOCATION2_PATH }}
          SSH_KEY: ${{ secrets.LOCATION2_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > deploy_key
          chmod 600 deploy_key
          ssh -i deploy_key -o StrictHostKeyChecking=no \
            ${SERVER_USER}@${SERVER_HOST} \
            "cd ${SERVER_PATH} && git pull origin main && composer install --no-dev --optimize-autoloader"
          rm -f deploy_key
      
      - name: Trigger Location 3
        env:
          SERVER_HOST: ${{ secrets.LOCATION3_HOST }}
          SERVER_USER: ${{ secrets.LOCATION3_USER }}
          SERVER_PATH: ${{ secrets.LOCATION3_PATH }}
          SSH_KEY: ${{ secrets.LOCATION3_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > deploy_key
          chmod 600 deploy_key
          ssh -i deploy_key -o StrictHostKeyChecking=no \
            ${SERVER_USER}@${SERVER_HOST} \
            "cd ${SERVER_PATH} && git pull origin main && composer install --no-dev --optimize-autoloader"
          rm -f deploy_key
      
      - name: Notify Success
        if: success()
        run: echo "✅ All 3 servers pulled latest code from GitHub"
      
      - name: Notify Failure
        if: failure()
        run: echo "❌ One or more servers failed to pull. Check logs."
