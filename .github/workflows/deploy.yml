name: Mirror to AlleyCat & Update Servers

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  mirror-and-deploy:
    runs-on: self-hosted  # Runs on your local machine, can reach LAN servers
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Mirror to alleycatphoto/acps-server
        env:
          ALLEYCATPHOTO_TOKEN: ${{ secrets.ALLEYCATPHOTO_TOKEN }}
        run: |
          git remote remove alleycatphoto 2>$null
          git remote add alleycatphoto https://x-access-token:$env:ALLEYCATPHOTO_TOKEN@github.com/alleycatphoto/acps-server.git
          git push alleycatphoto main --force
      
      - name: Wait for mirror to complete
        run: sleep 5
      
      - name: Update Hawks Nest Server
        env:
          SERVER_HOST: ${{ secrets.HAWK_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          SSH_KEY: ${{ secrets.CONPHOSERV_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > deploy_key
          chmod 600 deploy_key
          ssh -i deploy_key -o StrictHostKeyChecking=no \
            Owner@${SERVER_HOST} \
            "cd ${SERVER_PATH} && git pull origin main && composer install --no-dev --optimize-autoloader"
          rm -f deploy_key
      
      - name: Update Hawk Moon Server
        env:
          SERVER_HOST: ${{ secrets.MOON_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          SSH_KEY: ${{ secrets.CONPHOSERV_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > deploy_key
          chmod 600 deploy_key
          ssh -i deploy_key -o StrictHostKeyChecking=no \
            Owner@${SERVER_HOST} \
            "cd ${SERVER_PATH} && git pull origin main && composer install --no-dev --optimize-autoloader"
          rm -f deploy_key
      
      - name: Update Zip Server
        env:
          SERVER_HOST: ${{ secrets.ZIP_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          SSH_KEY: ${{ secrets.CONPHOSERV_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > deploy_key
          chmod 600 deploy_key
          ssh -i deploy_key -o StrictHostKeyChecking=no \
            Owner@${SERVER_HOST} \
            "cd ${SERVER_PATH} && git pull origin main && composer install --no-dev --optimize-autoloader"
          rm -f deploy_key
      
      - name: Notify Success
        if: success()
        run: echo "✅ Mirrored to alleycatphoto/acps-server and updated Hawks Nest, Hawk Moon, Zip servers"
      
      - name: Notify Failure
        if: failure()
        run: echo "❌ Mirror or server update failed. Check logs."